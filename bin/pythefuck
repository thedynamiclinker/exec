#!/usr/bin/env bash

# nix why-depends is shit
# here's an abbreviation that helps with
# our (admittedly insane) use case

[[ -z $1 ]] && echo "Give pypkg" && exit 1

pypkg="$1"
source ~/.bashrc
c nixos

SYS_ATTR=".#nixosConfigurations.$(hostname).config.system.build.toplevel"
SYS_DRV="$(nix eval --raw ${SYS_ATTR}.drvPath)" # this takes an eternity
SYS_CUR="$(nix eval --raw --impure --expr builtins.currentSystem)"

for py in 313 314 315 313FreeThreading 314FreeThreading 315FreeThreading; do
    echo "Why does our system depend on python${py}'s ${pypkg} package?"
    DEP_DRV="$(nix eval --raw .#legacyPackages.${SYS_CUR}.python${py}Packages.${pypkg}.drvPath)"
    nix why-depends "$SYS_DRV" "$DEP_DRV"
done
