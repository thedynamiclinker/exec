#!/usr/bin/env bash

usage() {
    [[ -n "$1" ]] && echo "${1}"
    cat << EOF
USAGE
    $(basename $0) [OPTIONS] <fmt> <files>

OPTIONS
    --help, -h      Show this help

EOF
    exit 1
}

orig_args=("$@")

fmt=
rmsrc=
args=()

[[ -z "$1" ]] && usage

if [[ "$1" =~ -* ]] && [[ ! -e "$1" ]]; then
    fmt="$1"
    shift
fi

while [[ -n "$1" ]]; do
    case "$1" in

        -h|--help)          usage;;

        -i|--inplace)       rmsrc=1;;

        -f|--fmt)
                            shift
                            fmt="$1"
                            ;;

        *)                  if [[ -e "$1" ]]; then
                                args+=("$1")
                            else
                                echo "not an option or a file: $1"
                                exit 1
                            fi
                            ;;
    esac
    shift
done

if [[ ${#args} = 0 ]]; then
    echo "no files provided by command: $(basename $0) ${orig_args[@]}"
    exit 1
fi

for f in "${args[@]}"; do
    echo magick "$f" "${f%.*}.${fmt}"
    if [[ -n "$rmsrc" ]]; then
        echo rm -v "$f";
    fi
done
