#!/usr/bin/env bash

usage() {
    [[ -n "$1" ]] && echo "${1}"
    cat <<- EOF

	NAME

	    $(basename $0) - convert any file to another format

	USAGE

	    $(basename $0) [OPTIONS] <fmt> <files>

	OPTIONS

	    --help,     -h          Show this help
	    --fmt,      -f          Specify output format (e.g., jpg, png)
	    --delete,   -d          Delete source files after conversion

	EXAMPLES

	    to png file.jpg
	    to jpg file.pdf
	
	EOF
    exit 1
}

orig_args=("$@")

fmt=
delete=
args=()

[[ -z "$1" ]] && usage

if [[ "$1" =~ -* ]] && [[ ! -e "$1" ]]; then
    fmt="$1"
    shift
fi

while [[ -n "$1" ]]; do
    case "$1" in

        -h|--help)          usage;;

        -d|--delete)        delete=1;;

        -f|--fmt)
                            shift
                            fmt="$1"
                            ;;

        *)                  if [[ -e "$1" ]]; then
                                args+=("$1")
                            else
                                echo "not an option or a file: $1"
                                exit 1
                            fi
                            ;;
    esac
    shift
done

if [[ ${#args} = 0 ]]; then
    echo "no files provided by command: $(basename $0) ${orig_args[@]}"
    exit 1
fi

for f in "${args[@]}"; do
    magick "$f" "${f%.*}.${fmt}"
    if [[ $? == 0 ]] && [[ -n "$delete" ]]; then
        rm -v "$f";
    fi
done
