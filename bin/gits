#!/bin/sh

# lib

if [[ ! -t 1 ]]; then
    red=""
    blu=""
    whi=""
    end=""
else
    red="${end}\e[1;31m"
    blu="${end}\e[1;34m"
    whi="${end}\e[1;39m"
    end="\e[00m"
fi

root="$PWD"

push() { 
    local d="$1";
    pushd "$d" > /dev/null;
    dir="${d/$root/}"
    dir="${dir#/}"
    printf "${whi}...${red}(${blu}${dir}${whi}${end}\n"
}

pop() { 
    dir="${PWD/$root/}"
    dir="${dir#/}"
    popd > /dev/null;
    printf "${whi}...${blu}${dir}${red})${end}\n"
}

# main

if [ -z $1 ]; then
    echo "usage: $(basename $0) <git-command> [dir]"
    exit 1
fi

cmd="${1}"
dir="${PWD}"

if [[ $cmd == clone ]]; then
    shift
    git clone-all $*
    exit 0
fi

if [ ! -d "$dir" ]; then
    echo "error: not a directory: $2"
    exit 1
fi

pushd "$dir" >/dev/null
find -L "$dir" -maxdepth 4 -type d -name .git -exec dirname '{}' ';' | while read repo; do

    [ ! -d "$repo/.git" ] && continue

    # now we know it's a repo

    echo "================="
    push "$repo"
    git "$@"
    pop
done
echo "================="
popd >/dev/null
